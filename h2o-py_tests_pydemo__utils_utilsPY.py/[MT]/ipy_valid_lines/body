def ipy_valid_lines(block):
    lines = [line for line in ipy_lines(block) if (not line.startswith('%'))]
    for line in lines:
        if ('import matplotlib.pyplot as plt' in line):
            import matplotlib
            matplotlib.use('Agg', warn=False)
    return [line for line in lines if (not ('plt.show()' in line))]
