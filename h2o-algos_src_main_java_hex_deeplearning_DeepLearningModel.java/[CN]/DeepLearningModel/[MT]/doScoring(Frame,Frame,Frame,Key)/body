{
  boolean keep_running;
  try {
    final long now=System.currentTimeMillis();
    epoch_counter=(float)model_info().get_processed_total() / training_rows;
    final double time_last_iter_millis=Math.max(5,now - _timeLastScoreEnter);
    if (H2O.CLOUD.size() > 1 && get_params()._train_samples_per_iteration == -2 && time_for_communication_us > 1e4) {
      final double comm_to_work_ratio=(time_for_communication_us * 1e-3) / time_last_iter_millis;
      final double correction=get_params()._target_ratio_comm_to_comp / comm_to_work_ratio;
      actual_train_samples_per_iteration/=correction;
      actual_train_samples_per_iteration=Math.max(1,actual_train_samples_per_iteration);
    }
    run_time+=time_last_iter_millis;
    _timeLastScoreEnter=now;
    keep_running=(epoch_counter < get_params()._epochs);
    final long sinceLastScore=now - _timeLastScoreStart;
    final long sinceLastPrint=now - _timeLastPrintStart;
    final long samples=model_info().get_processed_total();
    if (!keep_running || sinceLastPrint > get_params()._score_interval * 1000) {
      _timeLastPrintStart=now;
      Log.info("Training time: " + PrettyPrint.msecs(run_time,true) + ". Processed "+ String.format("%,d",samples)+ " samples"+ " ("+ String.format("%.3f",epoch_counter)+ " epochs)."+ " Speed: "+ String.format("%.3f",1000. * samples / run_time)+ " samples/sec.");
    }
    if (!keep_running || (sinceLastScore > get_params()._score_interval * 1000 && (double)(_timeLastScoreEnd - _timeLastScoreStart) / sinceLastScore < get_params()._score_duty_cycle)) {
      final boolean printme=!get_params()._quiet_mode;
      _timeLastScoreStart=now;
      if (get_params()._diagnostics)       model_info().computeStats();
      Errors err=new Errors();
      err.training_time_ms=run_time;
      err.epoch_counter=epoch_counter;
      err.training_samples=model_info().get_processed_total();
      err.validation=ftest != null;
      err.score_training_samples=ftrain.numRows();
      err.classification=_output.isClassifier();
      if (get_params()._autoencoder) {
        if (printme)         Log.info("Scoring the auto-encoder.");
{
          final Frame mse_frame=scoreAutoEncoder(ftrain);
          final Vec l2=mse_frame.anyVec();
          Log.info("Mean reconstruction error on training data: " + l2.mean() + "\n");
          err.train_mse=l2.mean();
          mse_frame.delete();
        }
      }
 else {
        if (printme)         Log.info("Scoring the model.");
        final String m=model_info().toString();
        if (m.length() > 0)         Log.info(m);
        final Frame trainPredict=score(ftrain);
        trainPredict.delete();
        hex.ModelMetrics mm1=hex.ModelMetrics.getFromDKV(this,ftrain);
        err.trainAUC=mm1._aucdata;
        err.train_confusion_matrix=mm1._cm;
        err.train_err=mm1._cm.err();
        err.train_hitratio=mm1._hr;
        err.train_mse=mm1._mse;
        if (ftest != null) {
          Frame validPred=score(ftest);
          validPred.delete();
          hex.ModelMetrics mm2=hex.ModelMetrics.getFromDKV(this,ftest);
          if (mm2 != null) {
            err.validAUC=mm2._aucdata;
            err.valid_confusion_matrix=mm2._cm;
            err.valid_err=mm2._cm.err();
            err.valid_hitratio=mm2._hr;
            err.valid_mse=mm2._mse;
          }
        }
        if (get_params()._variable_importances) {
          if (!get_params()._quiet_mode)           Log.info("Computing variable importances.");
          final float[] vi=model_info().computeVariableImportances();
          err.variable_importances=new VarImp(vi,Arrays.copyOfRange(model_info().data_info().coefNames(),0,vi.length));
        }
      }
      _timeLastScoreEnd=System.currentTimeMillis();
      err.scoring_time=System.currentTimeMillis() - now;
      if (errors == null) {
        errors=new Errors[]{err};
      }
 else {
        Errors[] err2=new Errors[errors.length + 1];
        System.arraycopy(errors,0,err2,0,errors.length);
        err2[err2.length - 1]=err;
        errors=err2;
      }
      if (!get_params()._autoencoder) {
        if (actual_best_model_key != null && ((DKV.get(actual_best_model_key) != null && (error() < DKV.get(actual_best_model_key).<DeepLearningModel>get().error() || !Arrays.equals(model_info().units,DKV.get(actual_best_model_key).<DeepLearningModel>get().model_info().units))) || (DKV.get(actual_best_model_key) == null && error() < _bestError))) {
          if (!get_params()._quiet_mode)           Log.info("Error reduced from " + _bestError + " to "+ error()+ ". Storing best model so far under key "+ actual_best_model_key.toString()+ ".");
          _bestError=error();
          putMeAsBestModel(actual_best_model_key,train);
        }
        for (        String s : toString().split("\n"))         Log.info(s);
        if (printme)         Log.info("Time taken for scoring and diagnostics: " + PrettyPrint.msecs(err.scoring_time,true));
      }
    }
    if (model_info().unstable()) {
      Log.warn(unstable_msg);
      keep_running=false;
    }
 else     if ((_output.isClassifier() && last_scored().train_err <= get_params()._classification_stop) || (!_output.isClassifier() && last_scored().train_mse <= get_params()._regression_stop)) {
      Log.info("Achieved requested predictive accuracy on the training data. Model building completed.");
      keep_running=false;
    }
    update(job_key);
  }
 catch (  Exception ex) {
    ex.printStackTrace();
    throw new RuntimeException(ex);
  }
  return keep_running;
}
