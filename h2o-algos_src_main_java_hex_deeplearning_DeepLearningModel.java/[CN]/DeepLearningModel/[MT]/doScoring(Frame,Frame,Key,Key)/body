{
  boolean keep_running;
  try {
    final long now=System.currentTimeMillis();
    epoch_counter=(float)model_info().get_processed_total() / training_rows;
    final double time_last_iter_millis=Math.max(5,now - _timeLastScoreEnter);
    if (H2O.CLOUD.size() > 1 && get_params()._train_samples_per_iteration == -2 && time_for_communication_us > 1e4) {
      final double comm_to_work_ratio=(time_for_communication_us * 1e-3) / time_last_iter_millis;
      final double correction=get_params()._target_ratio_comm_to_comp / comm_to_work_ratio;
      actual_train_samples_per_iteration/=correction;
      actual_train_samples_per_iteration=Math.max(1,actual_train_samples_per_iteration);
    }
    run_time+=time_last_iter_millis;
    _timeLastScoreEnter=now;
    keep_running=(epoch_counter < get_params()._epochs);
    final long sinceLastScore=now - _timeLastScoreStart;
    final long sinceLastPrint=now - _timeLastPrintStart;
    final long samples=model_info().get_processed_total();
    if (!keep_running || sinceLastPrint > get_params()._score_interval * 1000) {
      _timeLastPrintStart=now;
    }
    if (!keep_running || (sinceLastScore > get_params()._score_interval * 1000 && (double)(_timeLastScoreEnd - _timeLastScoreStart) / sinceLastScore < get_params()._score_duty_cycle)) {
      if (progressKey != null)       new Job.ProgressUpdate("Scoring...").fork(progressKey);
      final boolean printme=!get_params()._quiet_mode;
      _timeLastScoreStart=now;
      if (get_params()._diagnostics)       model_info().computeStats();
      DeepLearningScoring err=new DeepLearningScoring();
      err.training_time_ms=run_time;
      err.epoch_counter=epoch_counter;
      err.training_samples=model_info().get_processed_total();
      err.validation=ftest != null;
      err.score_training_samples=ftrain.numRows();
      err.classification=_output.isClassifier();
      if (get_params()._autoencoder) {
        if (printme)         Log.info("Scoring the auto-encoder.");
{
          final Frame mse_frame=scoreAutoEncoder(ftrain,Key.make());
          final Vec l2=mse_frame.anyVec();
          Log.info("Mean reconstruction error on training data: " + l2.mean() + "\n");
          err.train_mse=l2.mean();
          mse_frame.delete();
        }
      }
 else {
        if (printme)         Log.info("Scoring the model.");
        final String m=model_info().toString();
        if (m.length() > 0)         Log.info(m);
        final Frame trainPredict=score(ftrain);
        trainPredict.delete();
        hex.ModelMetricsSupervised mm1=(ModelMetricsSupervised)ModelMetrics.getFromDKV(this,ftrain);
        if (mm1 instanceof ModelMetricsBinomial) {
          ModelMetricsBinomial mm=(ModelMetricsBinomial)(mm1);
          err.trainAUC=mm._aucdata;
          err.train_confusion_matrix=mm._cm;
          err.train_err=mm._cm.err();
        }
 else         if (mm1 instanceof ModelMetricsMultinomial) {
          ModelMetricsMultinomial mm=(ModelMetricsMultinomial)(mm1);
          err.train_confusion_matrix=mm._cm;
          err.train_err=mm._cm.err();
          err.train_hitratio=mm._hit_ratios;
        }
        err.train_mse=mm1._mse;
        err.train_r2=mm1.r2();
        _output.trainMetrics=mm1;
        if (ftest != null) {
          Frame validPred=score(ftest);
          validPred.delete();
          hex.ModelMetricsSupervised mm2=(ModelMetricsSupervised)hex.ModelMetrics.getFromDKV(this,ftest);
          if (mm2 != null) {
            if (mm2 instanceof ModelMetricsBinomial) {
              ModelMetricsBinomial mm=(ModelMetricsBinomial)(mm2);
              err.validAUC=mm._aucdata;
              err.valid_confusion_matrix=mm._cm;
              err.valid_err=mm._cm.err();
            }
 else             if (mm2 instanceof ModelMetricsMultinomial) {
              ModelMetricsMultinomial mm=(ModelMetricsMultinomial)(mm2);
              err.valid_confusion_matrix=mm._cm;
              err.valid_err=mm._cm.err();
              err.valid_hitratio=mm._hit_ratios;
            }
            err.valid_mse=mm2._mse;
            err.valid_r2=mm2.r2();
            _output.validMetrics=mm2;
          }
        }
      }
      if (get_params()._variable_importances) {
        if (!get_params()._quiet_mode)         Log.info("Computing variable importances.");
        final float[] vi=model_info().computeVariableImportances();
        err.variable_importances=new VarImp(vi,Arrays.copyOfRange(model_info().data_info().coefNames(),0,vi.length));
      }
      _timeLastScoreEnd=System.currentTimeMillis();
      err.scoring_time=System.currentTimeMillis() - now;
      if (errors == null) {
        errors=new DeepLearningScoring[]{err};
      }
 else {
        DeepLearningScoring[] err2=new DeepLearningScoring[errors.length + 1];
        System.arraycopy(errors,0,err2,0,errors.length);
        err2[err2.length - 1]=err;
        errors=err2;
      }
      _output.errors=last_scored();
      _output.scoringHistory=createScoringHistoryTable(errors);
      _output.variableImportances=calcVarImp(last_scored().variable_importances);
      if (_output.modelSummary == null)       _output.modelSummary=model_info.createSummaryTable();
      if (!get_params()._autoencoder) {
        if (actual_best_model_key != null && ((DKV.get(actual_best_model_key) != null && (error() < DKV.get(actual_best_model_key).<DeepLearningModel>get().error() || !Arrays.equals(model_info().units,DKV.get(actual_best_model_key).<DeepLearningModel>get().model_info().units))) || (DKV.get(actual_best_model_key) == null && error() < _bestError))) {
          if (!get_params()._quiet_mode)           Log.info("Error reduced from " + _bestError + " to "+ error()+ ". Storing best model so far under key "+ actual_best_model_key.toString()+ ".");
          _bestError=error();
          putMeAsBestModel(actual_best_model_key);
        }
        if (keep_running)         for (        String s : toString().split("\n"))         Log.info(s);
        if (printme)         Log.info("Time taken for scoring and diagnostics: " + PrettyPrint.msecs(err.scoring_time,true));
      }
    }
    if (model_info().unstable()) {
      Log.warn(unstable_msg);
      keep_running=false;
    }
 else     if ((_output.isClassifier() && last_scored().train_err <= get_params()._classification_stop) || (!_output.isClassifier() && last_scored().train_mse <= get_params()._regression_stop)) {
      Log.info("Achieved requested predictive accuracy on the training data. Model building completed.");
      keep_running=false;
    }
    update(job_key);
  }
 catch (  Exception ex) {
    throw new RuntimeException(ex);
  }
  return keep_running;
}
