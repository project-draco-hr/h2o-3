{
  Key parsed=Key.make("prostate_parsed");
  Key modelKey=Key.make("prostate_model");
  GLMModel model=null;
  Frame fr=parse_test_file(parsed,"smalldata/logreg/prostate.csv");
  Key k=Key.make("rebalanced");
  fr.remove("ID").remove();
  DKV.put(fr._key,fr);
  Key betaConsKey=Key.make("beta_constraints");
  String[] cfs1=new String[]{"RACE","AGE","DPROS","DCAPS","PSA","VOL","GLEASON","Intercept"};
  double[] vals=new double[]{0,0,0.54788332,0.53816534,0.02380097,0,0.98115670,-8.945984};
  FVecTest.makeByteVec(betaConsKey,"names, beta_given, rho\n AGE, 0.1, 1\n RACE, -0.1, 1 \n DPROS, 10, 1 \n DCAPS, -10, 1 \n PSA, 0, 1\n VOL, 0, 1\nGLEASON, 0, 1\n Intercept, 0, 0 \n");
  Frame betaConstraints=ParseDataset.parse(Key.make("beta_constraints.hex"),new Key[]{betaConsKey});
  try {
    GLMParameters params=new GLMParameters();
    params._standardize=false;
    params._family=Family.binomial;
    params._beta_constraint=betaConstraints._key;
    params._response_column="CAPSULE";
    params._ignored_columns=new String[]{"ID"};
    params._train=fr._key;
    params._alpha=new double[]{0};
    params._lambda=new double[]{0};
    GLM job=new GLM(modelKey,"glm test simple poisson",params);
    job.trainModel().get();
    model=DKV.get(modelKey).get();
    double[] beta_1=model.beta();
    params._solver=Solver.L_BFGS;
    params._max_iter=1000;
    job=new GLM(modelKey,"glm test simple poisson",params);
    job.trainModel().get();
    model=DKV.get(modelKey).get();
    double[] beta_2=model.beta();
    System.out.println("beta1 = " + Arrays.toString(beta_1));
    System.out.println("beta2 = " + Arrays.toString(beta_2));
    fr.add("CAPSULE",fr.remove("CAPSULE"));
    DataInfo dinfo=new DataInfo(Key.make(),fr,null,1,true,TransformType.NONE,DataInfo.TransformType.NONE,true);
    LBFGS_LogisticGradientTask lt=(LBFGS_LogisticGradientTask)new LBFGS_LogisticGradientTask(dinfo,params,0,beta_1,1.0 / 380.0).doAll(dinfo._adaptedFrame);
    LBFGS_LogisticGradientTask lt2=(LBFGS_LogisticGradientTask)new LBFGS_LogisticGradientTask(dinfo,params,0,beta_2,1.0 / 380.0).doAll(dinfo._adaptedFrame);
    GLMGradientTask glmt=new GLMGradientTask(dinfo,params,0,beta_1,1.0 / 380).doAll(dinfo._adaptedFrame);
    double[] grad=lt._gradient;
    double[] grad_2=lt2._gradient;
    for (int i=0; i < beta_1.length; ++i)     assertEquals(0,grad[i] + betaConstraints.vec("rho").at(i) * (beta_1[i] - betaConstraints.vec("beta_given").at(i)),1e-5);
    for (int i=0; i < beta_1.length; ++i)     assertEquals(0,grad_2[i] + betaConstraints.vec("rho").at(i) * (beta_1[i] - betaConstraints.vec("beta_given").at(i)),1e-4);
  }
  finally {
    for (    Vec v : betaConstraints.vecs())     v.remove();
    DKV.remove(betaConstraints._key);
    betaConstraints.delete();
    for (    Vec v : fr.vecs())     v.remove();
    DKV.remove(fr._key);
    if (model != null)     model.delete();
  }
}
